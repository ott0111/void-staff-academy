<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Void Staff Academy • Certification</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/app.css"/>
</head>

<body class="fade-page">
  <div class="aurora"></div>
  <div class="grain"></div>

  <header class="topbar">
    <div class="container">
      <div class="inner">
        <a class="brand" href="index.html">
          <div class="mark"></div>
          <div class="title">
            <b>VOID STAFF ACADEMY</b>
            <span>Governance • Training • Compliance</span>
          </div>
        </a>

        <nav class="nav">
          <a data-nav href="index.html">Home</a>
          <a data-nav href="moderation.html">Moderation</a>
          <a data-nav href="roster.html">Roster</a>
          <a data-nav href="operations.html">Command Center</a>
          <a data-nav href="certification.html">Certification</a>
        </nav>

        <div class="actions">
          <button id="adminBtn" class="btn" type="button">Admin</button>
          <span class="kbd">Ctrl/⌘ K</span>
          <button id="mobileOpen" class="btn ghost mobileBtn" type="button" aria-label="Open menu">
            <span class="icon">☰</span> Menu
          </button>
        </div>
      </div>
    </div>
  </header>

  <div id="mobileSheet" class="mobileSheet">
    <div class="shade"></div>
    <div class="panel">
      <div class="head">
        <b>Navigation</b>
        <button id="mobileClose" class="btn ghost" type="button">Close</button>
      </div>
      <div class="links">
        <a data-nav href="index.html">Home</a>
        <a data-nav href="moderation.html">Moderation</a>
        <a data-nav href="roster.html">Roster</a>
        <a data-nav href="operations.html">Command Center</a>
        <a data-nav href="certification.html">Certification</a>
        <a data-nav href="recruitment.html">Recruitment</a>
        <a data-nav href="leadership.html">Leadership</a>
      </div>
    </div>
  </div>

  <main>
    <div class="container">

      <section class="hero reveal" data-reveal>
        <div class="content" style="grid-template-columns:1fr;">
          <div>
            <div class="eyebrow">
              <span class="pill">Scenario Exam • Cloud Logged</span>
              <span class="pill">30 Questions</span>
              <span class="pill">Pass: 80%</span>
            </div>
            <div class="h1">Certification Portal</div>
            <p class="sub">
              This exam is intentionally difficult. It measures judgement: ticket tone, routing, proof checks,
              escalation discipline, and staff safety. Every attempt is written to the cloud.
            </p>
          </div>
        </div>
      </section>

      <section class="examGrid">
        <!-- LEFT -->
        <div class="qCard reveal" data-reveal>
          <div class="qTitle">
            <b>Candidate Session</b>
            <span id="statusMono">Status: loading</span>
          </div>

          <div class="hr"></div>

          <div id="startPanel">
            <div class="field">
              <div class="label">Discord tag / username</div>
              <input id="candidateName" class="input" placeholder="e.g. VoidYeezy#0001 or @VoidYeezy" maxlength="40"/>
              <div class="help">This is saved with your attempt for audit.</div>
            </div>

            <div class="row">
              <button id="beginBtn" class="btn primary" type="button">Begin Exam</button>
              <a class="btn ghost" href="index.html">Go Back</a>
            </div>
          </div>

          <div id="examPanel" class="hidden">
            <div class="field">
              <div class="label">Progress</div>
              <div class="progress"><div id="bar"></div></div>
              <div class="help"><span id="progText">0/30 answered</span> • Required to pass: <b id="needText">—</b></div>
            </div>

            <div class="hr"></div>

            <div id="questionHost"></div>

            <div class="row" style="margin-top:14px; justify-content:space-between;">
              <button id="prevBtn" class="btn ghost" type="button">← Previous</button>
              <div class="row">
                <button id="submitBtn" class="btn primary" type="button">Submit</button>
              </div>
              <button id="nextBtn" class="btn ghost" type="button">Next →</button>
            </div>

            <div class="hr"></div>
            <div class="help">
              <b>Rule:</b> Don’t “speed-run.” The best answer is the one that follows protocol AND protects the server.
            </div>
          </div>

          <div id="resultPanel" class="hidden">
            <div class="qTitle">
              <b>Attempt Result</b>
              <span id="resultBadge" class="badge">—</span>
            </div>
            <div class="hr"></div>
            <div id="resultText" class="sub"></div>
            <div class="hr"></div>
            <div class="row">
              <button id="reviewBtn" class="btn" type="button">Review Answers</button>
              <button id="resetBtn" class="btn primary" type="button">New Attempt</button>
            </div>

            <div id="reviewHost" class="hidden" style="margin-top:16px;"></div>
          </div>
        </div>

        <!-- RIGHT -->
        <aside class="qCard reveal" data-reveal>
          <div class="qTitle">
            <b>Attempt Rules</b>
            <span style="font-family:var(--mono);font-size:11px;color:var(--muted)">Supabase</span>
          </div>
          <div class="hr"></div>

          <div class="row" style="gap:10px;">
            <span class="badge">Questions: <b>30</b></span>
            <span class="badge warn">Pass: <b>80%</b></span>
            <span class="badge good">Cloud: <b>Enabled</b></span>
          </div>

          <div class="hr"></div>

          <div class="field">
            <div class="label">What gets logged</div>
            <div class="help">
              Candidate name, score, pass/fail, timestamp, and all question answers.
              Admin view is protected by Supabase Auth + RLS.
            </div>
          </div>

          <div class="hr"></div>

          <div class="field">
            <div class="label">Integrity</div>
            <div class="help">
              You can retry, but staff can review attempt history and answer patterns.
            </div>
          </div>
        </aside>
      </section>

      <div class="footer reveal" data-reveal>
        <div class="split">
          <div>Void Staff Academy • Certification System</div>
          <div>© 2026 Void Esports. All rights reserved.</div>
        </div>
      </div>

    </div>
  </main>

  <!-- Admin modal -->
  <div id="adminModal" class="backdrop" role="dialog" aria-modal="true" aria-label="Admin panel">
    <div class="modal" style="width:min(1040px, 100%);">
      <div class="hd">
        <b>Admin Control Dashboard</b>
        <button id="adminClose" class="btn ghost" type="button">Close</button>
      </div>
      <div class="bd">
        <!-- AUTH GATE -->
        <div id="adminGate">
          <div class="field">
            <div class="label">Admin email</div>
            <input id="adminEmail" type="email" placeholder="you@domain.com" />
          </div>
          <div class="field">
            <div class="label">Admin password</div>
            <input id="adminPass" type="password" placeholder="••••••••" />
            <div class="help">This is Supabase Auth. Not a client-side “fake password.”</div>
          </div>
          <div class="row">
            <button id="adminLogin" class="btn primary" type="button">Login</button>
            <button id="adminLogout" class="btn" type="button">Logout</button>
          </div>
          <div id="adminGateMsg" class="help" style="margin-top:10px;"></div>
        </div>

        <!-- ADMIN PANEL -->
        <div id="adminPanel" class="hidden">
          <div class="row" style="justify-content:space-between; align-items:flex-end; gap:12px;">
            <div style="flex:1;">
              <div class="field" style="margin:0;">
                <div class="label">Search attempts</div>
                <input id="adminSearch" placeholder="Search by name, pass/fail, score, date…" />
              </div>
            </div>
            <div class="row" style="align-items:end;">
              <button id="refreshBtn" class="btn" type="button">Refresh</button>
            </div>
          </div>

          <div class="hr"></div>

          <!-- Analytics -->
          <div class="grid" style="margin-top:0;">
            <div class="card" style="grid-column: span 6;">
              <h3>Pass/Fail Analytics</h3>
              <p class="small">Live metrics from cloud logs.</p>
              <div class="hr"></div>
              <div id="analyticsBox" class="help">Loading…</div>
            </div>

            <div class="card" style="grid-column: span 6;">
              <h3>Admin Session</h3>
              <p class="small">Only allowed admin emails can view logs (RLS enforced).</p>
              <div class="hr"></div>
              <div id="sessionBox" class="help">Loading…</div>
            </div>
          </div>

          <div class="hr"></div>

          <table class="table" aria-label="Attempts table">
            <thead>
              <tr>
                <th>Time</th>
                <th>Candidate</th>
                <th>Score</th>
                <th>Status</th>
                <th>Details</th>
              </tr>
            </thead>
            <tbody id="attemptTable"></tbody>
          </table>

          <div id="attemptDetail" class="qCard hidden" style="margin-top:14px;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Command palette -->
  <div id="cmdPalette" class="backdrop" role="dialog" aria-modal="true" aria-label="Command palette">
    <div class="modal">
      <div class="hd">
        <b>Command Palette</b>
        <span class="kbd">Esc</span>
      </div>
      <div class="bd">
        <input id="cmdInput" placeholder="Type to search… (Home, Moderation, Roster, Certification)" />
        <div id="cmdList" class="cmd-list"></div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script src="assets/app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
  /**********************
   * CONFIG — CHANGE ME
   **********************/
  const SUPABASE_URL = "https://jzvnqbwcfgnhunulhuk.supabase.co";
  const SUPABASE_KEY = "sb_publishable_Q1YlgilLpktVG2Wm9kN1MQ_0hQC-rol";

  // Only these emails can view admin logs (RLS ALSO MUST MATCH THIS LIST)
  const ADMIN_EMAIL_ALLOWLIST = [
    "opeyemiadegoke77@gmail.com"
  ];

  const PASS_PERCENT = 80;
  const TOTAL_Q = 30;

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  /**********************
   * QUESTIONS (30)
   * Hard but clear.
   **********************/
  const QUESTIONS = [
    { q:"Ticket opens. Best FIRST message?", choices:[
      "yo what you need",
      "Hello, how may I help you today?",
      "Send tracker rn",
      "Hold on I’m busy"
    ], a:1 },

    { q:"After greeting, what is REQUIRED before routing staff/roster applications?", choices:[
      "Ask their favorite skin",
      "Confirm age (and be clear)",
      "Ask for Nitro",
      "Ask if they’re rich"
    ], a:1 },

    { q:"User says: “I’m 13 but mature.” Correct action?", choices:[
      "Let them in anyway",
      "Politely stop + follow underage procedure and document",
      "Ignore it",
      "Tell them to lie next time"
    ], a:1 },

    { q:"A user wants Pro roster. What proof bundle is the best standard request?", choices:[
      "Only a TikTok link",
      "Tracker + lobby proof + earnings proof (if required) + identity match",
      "Just tell them yes",
      "Only screenshots of settings"
    ], a:1 },

    { q:"A roster applicant sends a tracker that doesn’t match their Discord/IGN. Best move?", choices:[
      "Accept anyway",
      "Ask them to confirm IGN + provide matching proof before role changes",
      "Argue with them",
      "Ban instantly"
    ], a:1 },

    { q:"Creative applicant: best validation approach?", choices:[
      "Ask for 2–3 recent clips + verify uniqueness + route to Creative lead",
      "Only ask for PR",
      "Only ask for earnings",
      "Don’t ask anything"
    ], a:0 },

    { q:"Content Creator applicant: what matters MOST for routing?", choices:[
      "Their ranked skin",
      "Their socials + consistent quality + follower thresholds (if required)",
      "Their keyboard brand",
      "Their ping"
    ], a:1 },

    { q:"Jr Content Creator role: best decision logic?", choices:[
      "If they’re close to thresholds + quality is good + consistent posting",
      "Only if they have earnings",
      "Only if they have PR",
      "Never give Jr CC"
    ], a:0 },

    { q:"GFX/VFX applicant: best required artifact?", choices:[
      "A portfolio of work (links or images) + consistency expectation",
      "Tracker",
      "Earnings",
      "Only a promise"
    ], a:0 },

    { q:"Escalation rule: when do you escalate?", choices:[
      "Every ticket",
      "Complex/sensitive cases with evidence + context summary",
      "Never",
      "Only when bored"
    ], a:1 },

    { q:"You’re unsure if proof is edited/fake. Best action?", choices:[
      "Call them names",
      "Request additional verification and escalate with concerns + screenshots",
      "Accept anyway",
      "Ignore it"
    ], a:1 },

    { q:"Correct location for warn command usage?", choices:[
      "General chat",
      "#staff-commands only",
      "DMs",
      "Anywhere"
    ], a:1 },

    { q:"Correct warn syntax (per your protocol)?", choices:[
      "*warn user-id reason",
      "/warn @user",
      "!warn user",
      "warn user reason"
    ], a:0 },

    { q:"A user is spamming in a ticket and insulting staff. Best professional response?", choices:[
      "Insult back",
      "Warn calmly, set boundary, document, escalate if needed",
      "Delete ticket instantly no notes",
      "Ghost them"
    ], a:1 },

    { q:"Ticket closure should include:", choices:[
      "No message just close",
      "Final confirmation + next steps (name change/code proof) + polite close",
      "A meme",
      "Arguing"
    ], a:1 },

    { q:"Minimum documentation expectation when routing to leadership:", choices:[
      "Only vibes",
      "Short summary + evidence + what you already asked + what you need decided",
      "Nothing",
      "A long rant"
    ], a:1 },

    { q:"User asks for role but refuses to show any proof. Best outcome?", choices:[
      "Give role anyway",
      "Explain proof requirement; if they refuse, end politely and document",
      "Threaten them",
      "Beg them"
    ], a:1 },

    { q:"A staff member tells you to ‘skip age checks to go faster’. Best response?", choices:[
      "Agree",
      "Do NOT skip; follow protocol; if pressured, escalate to leadership",
      "Ignore",
      "Laugh"
    ], a:1 },

    { q:"Operations: correct shift start command?", choices:[
      "/start",
      "/login",
      "/shift",
      "/begin"
    ], a:1 },

    { q:"Operations: correct shift end command?", choices:[
      "/logout",
      "/end",
      "/stop",
      "/leave"
    ], a:0 },

    { q:"LOA request should include:", choices:[
      "Only emojis",
      "Duration + reason (and notify if extended)",
      "Nothing",
      "A random lie"
    ], a:1 },

    { q:"Report command usage is best for:", choices:[
      "Small typo",
      "Major or repeated infractions WITH documentation",
      "Jokes",
      "Asking for roles"
    ], a:1 },

    { q:"Recruitment: most important early screen for staff applicants?", choices:[
      "Do they have earnings",
      "Age honesty + motivation + availability + communication clarity",
      "Do they have rare skins",
      "Do they type fast"
    ], a:1 },

    { q:"Recruitment: if answers feel dishonest or ‘off’, best action?", choices:[
      "Push them through anyway",
      "Stop process politely; don’t pass them to exam",
      "Argue",
      "Expose them publicly"
    ], a:1 },

    { q:"Leadership: escalation is not “snitching” because…", choices:[
      "It’s how standards and safety stay consistent and documented",
      "It’s for drama",
      "It wastes time",
      "It’s optional always"
    ], a:0 },

    { q:"A ticket is ‘Roster’ but user actually wants GFX/VFX. Best routing?", choices:[
      "Keep them in roster forever",
      "Clarify request, move/route to GFX/VFX lead, document",
      "Ignore",
      "Close instantly"
    ], a:1 },

    { q:"A user wants Semi-Pro. They meet PR but no earnings. Best decision?", choices:[
      "Semi-Pro anyway",
      "Follow standard: if earnings required, deny/offer Academy/Grinder+; document",
      "Ban them",
      "Call them bad"
    ], a:1 },

    { q:"A user sends proof but is extremely toxic. Best action?", choices:[
      "Accept role because proof is proof",
      "Consider conduct: warn/report if needed; escalate before granting roles",
      "Ignore toxicity always",
      "Argue"
    ], a:1 },

    { q:"Most professional tone guideline?", choices:[
      "Match their insults",
      "Stay calm, short, respectful, and factual",
      "Spam emojis",
      "Use slang only"
    ], a:1 },

    { q:"Final check before assigning any role:", choices:[
      "No check needed",
      "Verify proof matches person + correct routing + clean documentation",
      "Ask for Nitro",
      "Ask if they like Void"
    ], a:1 },
  ];

  /**********************
   * DOM
   **********************/
  const statusMono = document.getElementById("statusMono");
  const startPanel = document.getElementById("startPanel");
  const examPanel = document.getElementById("examPanel");
  const resultPanel = document.getElementById("resultPanel");

  const candidateName = document.getElementById("candidateName");
  const beginBtn = document.getElementById("beginBtn");
  const questionHost = document.getElementById("questionHost");

  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");
  const submitBtn = document.getElementById("submitBtn");

  const bar = document.getElementById("bar");
  const progText = document.getElementById("progText");
  const needText = document.getElementById("needText");

  const resultBadge = document.getElementById("resultBadge");
  const resultText = document.getElementById("resultText");
  const reviewBtn = document.getElementById("reviewBtn");
  const resetBtn = document.getElementById("resetBtn");
  const reviewHost = document.getElementById("reviewHost");

  // Admin modal + auth
  const adminBtn = document.getElementById("adminBtn");
  const adminModal = document.getElementById("adminModal");
  const adminClose = document.getElementById("adminClose");

  const adminGate = document.getElementById("adminGate");
  const adminPanel = document.getElementById("adminPanel");

  const adminEmail = document.getElementById("adminEmail");
  const adminPass = document.getElementById("adminPass");
  const adminLogin = document.getElementById("adminLogin");
  const adminLogout = document.getElementById("adminLogout");
  const adminGateMsg = document.getElementById("adminGateMsg");

  const adminSearch = document.getElementById("adminSearch");
  const refreshBtn = document.getElementById("refreshBtn");

  const analyticsBox = document.getElementById("analyticsBox");
  const sessionBox = document.getElementById("sessionBox");

  const attemptTable = document.getElementById("attemptTable");
  const attemptDetail = document.getElementById("attemptDetail");

  /**********************
   * EXAM STATE
   **********************/
  let idx = 0;
  let answers = Array(TOTAL_Q).fill(null);

  function setStatus(s){ statusMono.textContent = "Status: " + s; }
  function answeredCount(){ return answers.filter(v => v !== null).length; }

  function requiredCorrect(){
    return Math.ceil((PASS_PERCENT / 100) * TOTAL_Q);
  }

  function renderProgress(){
    const done = answeredCount();
    const pct = Math.round((done / TOTAL_Q) * 100);
    bar.style.width = pct + "%";
    progText.textContent = `${done}/${TOTAL_Q} answered`;
    needText.textContent = `${requiredCorrect()}/${TOTAL_Q}`;
  }

  function renderQuestion(){
    const q = QUESTIONS[idx];
    const chosen = answers[idx];

    questionHost.innerHTML = `
      <div class="qTitle">
        <b>Question ${idx+1}</b>
        <span style="font-family:var(--mono);font-size:11px;color:var(--muted)">${idx+1}/${TOTAL_Q}</span>
      </div>

      <div style="margin-top:10px;color:rgba(238,240,255,.92);font-size:14px;line-height:1.5">
        ${escapeHTML(q.q)}
      </div>

      <div style="display:grid;gap:10px;margin-top:12px;">
        ${q.choices.map((c,i)=>`
          <label class="choice">
            <input type="radio" name="q" ${chosen===i ? "checked":""} data-choice="${i}">
            <div class="txt">${escapeHTML(c)}</div>
          </label>
        `).join("")}
      </div>
    `;

    questionHost.querySelectorAll("input[type=radio]").forEach(r=>{
      r.addEventListener("change", ()=>{
        const v = Number(r.getAttribute("data-choice"));
        answers[idx] = v;
        renderProgress();
        if (window.VOIDToast) VOIDToast("Saved answer for Q" + (idx+1));
      });
    });

    prevBtn.disabled = (idx === 0);
    nextBtn.disabled = (idx === TOTAL_Q - 1);
  }

  function scoreExam(){
    let correct = 0;
    const perQ = QUESTIONS.map((q,i)=>{
      const picked = answers[i];
      const ok = picked === q.a;
      if(ok) correct++;
      return {i, picked, ok};
    });
    const percent = Math.round((correct / TOTAL_Q) * 100);
    const passed = percent >= PASS_PERCENT;
    return {correct, percent, passed, perQ};
  }

  function showPanels(which){
    startPanel.classList.toggle("hidden", which !== "start");
    examPanel.classList.toggle("hidden", which !== "exam");
    resultPanel.classList.toggle("hidden", which !== "result");
  }

  function resetExam(){
    idx = 0;
    answers = Array(TOTAL_Q).fill(null);
    showPanels("start");
    setStatus("idle");
    renderProgress();
    reviewHost.classList.add("hidden");
    reviewHost.innerHTML = "";
  }

  /**********************
   * SUPABASE: SAVE ATTEMPT
   **********************/
  async function saveAttempt(attempt){
    const { error } = await supabase
      .from("certification_attempts")
      .insert([{
        candidate: attempt.candidate,
        percent: attempt.percent,
        correct: attempt.correct,
        passed: attempt.passed,
        answers: attempt.answers
      }]);

    if(error){
      console.error(error);
      if (window.VOIDToast) VOIDToast("Database error. Check RLS/policies.");
      throw error;
    }
  }

  /**********************
   * CANDIDATE FLOW
   **********************/
  beginBtn.addEventListener("click", ()=>{
    const name = candidateName.value.trim();
    if(!name){
      if (window.VOIDToast) VOIDToast("Enter your Discord name.");
      return;
    }
    idx = 0;
    answers = Array(TOTAL_Q).fill(null);
    showPanels("exam");
    setStatus("in progress");
    renderProgress();
    renderQuestion();
    if (window.VOIDToast) VOIDToast("Exam started.");
  });

  prevBtn.addEventListener("click", ()=>{ idx = Math.max(0, idx-1); renderQuestion(); });
  nextBtn.addEventListener("click", ()=>{ idx = Math.min(TOTAL_Q-1, idx+1); renderQuestion(); });

  submitBtn.addEventListener("click", async ()=>{
    if(answeredCount() < TOTAL_Q){
      if (window.VOIDToast) VOIDToast("Answer all 30 questions before submitting.");
      return;
    }

    const name = candidateName.value.trim() || "Unknown";
    const r = scoreExam();

    const attempt = {
      candidate: name,
      percent: r.percent,
      correct: r.correct,
      passed: r.passed,
      answers: QUESTIONS.map((q,i)=>({
        q: q.q,
        picked: answers[i],
        pickedText: q.choices[answers[i]],
        correct: q.a,
        correctText: q.choices[q.a],
        ok: answers[i] === q.a
      }))
    };

    submitBtn.disabled = true;
    submitBtn.textContent = "Submitting…";

    try{
      await saveAttempt(attempt);

      showPanels("result");
      setStatus("submitted");

      resultBadge.className = "badge " + (attempt.passed ? "good":"bad");
      resultBadge.textContent = attempt.passed ? "PASS" : "FAIL";

      resultText.innerHTML = `
        Candidate: <b>${escapeHTML(attempt.candidate)}</b><br/>
        Score: <b>${attempt.correct}/${TOTAL_Q}</b> • <b>${attempt.percent}%</b><br/>
        Required: <b>${PASS_PERCENT}%</b>
      `;

      if (window.VOIDToast) VOIDToast(attempt.passed ? "Certified." : "Not passed — review and retry.");
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = "Submit";
    }
  });

  reviewBtn.addEventListener("click", ()=>{
    const r = scoreExam();
    reviewHost.innerHTML = r.perQ.map(x=>{
      const q = QUESTIONS[x.i];
      const picked = answers[x.i];
      const pickedText = picked === null ? "—" : q.choices[picked];
      const ok = x.ok;

      return `
        <div class="qCard" style="margin-bottom:12px;">
          <div class="qTitle">
            <b>Q${x.i+1} • ${ok ? "Correct":"Incorrect"}</b>
            <span class="${ok ? "badge good":"badge bad"}">${ok ? "OK":"MISS"}</span>
          </div>
          <div style="margin-top:10px;color:rgba(238,240,255,.92);">${escapeHTML(q.q)}</div>
          <div class="hr"></div>
          <div class="help">
            Your answer: <b>${escapeHTML(pickedText)}</b><br/>
            Correct answer: <b>${escapeHTML(q.choices[q.a])}</b>
          </div>
        </div>
      `;
    }).join("");
    reviewHost.classList.remove("hidden");
  });

  resetBtn.addEventListener("click", resetExam);

  /**********************
   * ADMIN: SECURE AUTH + RLS GATE
   **********************/
  function openAdmin(){ adminModal.classList.add("show"); }
  function closeAdmin(){ adminModal.classList.remove("show"); }

  adminBtn.addEventListener("click", async ()=>{
    openAdmin();
    await syncAdminUI();
  });

  adminClose.addEventListener("click", closeAdmin);
  adminModal.addEventListener("click", (e)=>{ if(e.target === adminModal) closeAdmin(); });

  adminLogin.addEventListener("click", async ()=>{
    adminGateMsg.textContent = "";
    const email = adminEmail.value.trim().toLowerCase();
    const pass = adminPass.value;

    const { data, error } = await supabase.auth.signInWithPassword({ email, password: pass });
    if(error){
      console.error(error);
      adminGateMsg.textContent = "Login failed. Check email/password.";
      return;
    }
    await syncAdminUI();
    if (window.VOIDToast) VOIDToast("Admin signed in.");
  });

  adminLogout.addEventListener("click", async ()=>{
    await supabase.auth.signOut();
    await syncAdminUI();
    if (window.VOIDToast) VOIDToast("Signed out.");
  });

  supabase.auth.onAuthStateChange(async ()=>{
    // keep UI in sync if session changes
    await syncAdminUI();
  });

  function isAdminEmail(email){
    return ADMIN_EMAIL_ALLOWLIST.includes((email||"").toLowerCase());
  }

  async function syncAdminUI(){
    const { data } = await supabase.auth.getSession();
    const session = data.session;

    if(!session){
      adminGateMsg.textContent = "Not logged in.";
      adminPanel.classList.add("hidden");
      adminGate.classList.remove("hidden");
      sessionBox.textContent = "Session: none";
      attemptTable.innerHTML = "";
      attemptDetail.classList.add("hidden");
      return;
    }

    const email = session.user?.email || "";
    sessionBox.innerHTML = `
      Logged in as: <b>${escapeHTML(email)}</b><br/>
      Role: <span style="font-family:var(--mono)">${escapeHTML(session.user?.role || "authenticated")}</span>
    `;

    if(!isAdminEmail(email)){
      adminGateMsg.textContent = "You are logged in, but not authorized as admin.";
      adminPanel.classList.add("hidden");
      adminGate.classList.remove("hidden");
      // Safety: force sign-out if non-admin logged in on this device
      await supabase.auth.signOut();
      sessionBox.textContent = "Session: unauthorized (signed out)";
      return;
    }

    adminGateMsg.textContent = "Authorized.";
    adminGate.classList.add("hidden");
    adminPanel.classList.remove("hidden");

    await loadAdminData();
  }

  adminSearch.addEventListener("input", ()=>{ loadAdminData(); });
  refreshBtn.addEventListener("click", ()=>{ loadAdminData(); });

  async function loadAdminData(){
    // Pull attempts (RLS must allow only admin emails to select)
    const q = (adminSearch.value || "").toLowerCase().trim();

    const { data, error } = await supabase
      .from("certification_attempts")
      .select("id, created_at, candidate, percent, correct, passed, answers")
      .order("created_at", { ascending: false })
      .limit(500);

    if(error){
      console.error(error);
      analyticsBox.textContent = "Failed to load admin data. Check RLS policies.";
      attemptTable.innerHTML = "";
      return;
    }

    const filtered = !q ? data : data.filter(a=>{
      const blob = `${a.created_at} ${a.candidate} ${a.percent} ${a.correct} ${a.passed ? "pass":"fail"}`.toLowerCase();
      return blob.includes(q);
    });

    renderAnalytics(data);
    renderAttemptsTable(filtered);
  }

  function renderAttemptsTable(rows){
    attemptDetail.classList.add("hidden");
    attemptDetail.innerHTML = "";

    attemptTable.innerHTML = rows.map(a=>{
      return `
        <tr>
          <td style="font-family:var(--mono);font-size:12px;">${escapeHTML(new Date(a.created_at).toLocaleString())}</td>
          <td><b>${escapeHTML(a.candidate || "—")}</b></td>
          <td style="font-family:var(--mono)">${a.correct}/${TOTAL_Q} • ${a.percent}%</td>
          <td><span class="badge ${a.passed ? "good":"bad"}">${a.passed ? "PASS":"FAIL"}</span></td>
          <td><button class="btn ghost" type="button" data-view="${a.id}">View</button></td>
        </tr>
      `;
    }).join("");

    attemptTable.querySelectorAll("[data-view]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-view");
        const found = rows.find(x => x.id === id);
        if(!found){ if (window.VOIDToast) VOIDToast("Not found."); return; }
        viewAttempt(found);
      });
    });
  }

  function viewAttempt(a){
    const answers = Array.isArray(a.answers) ? a.answers : [];
    attemptDetail.classList.remove("hidden");
    attemptDetail.innerHTML = `
      <div class="qTitle">
        <b>Attempt Details</b>
        <span class="badge ${a.passed ? "good":"bad"}">${a.passed ? "PASS":"FAIL"} • ${a.percent}%</span>
      </div>
      <div class="hr"></div>
      <div class="help">
        Candidate: <b>${escapeHTML(a.candidate || "—")}</b><br/>
        Time: <span style="font-family:var(--mono)">${escapeHTML(new Date(a.created_at).toLocaleString())}</span><br/>
        Correct: <b>${a.correct}/${TOTAL_Q}</b>
      </div>
      <div class="hr"></div>
      ${answers.map((x,i)=>`
        <div style="padding:10px 0;border-bottom:1px solid rgba(255,255,255,.06)">
          <div style="font-weight:700">Q${i+1}</div>
          <div class="help" style="margin-top:6px">${escapeHTML(x.q || "")}</div>
          <div class="row" style="margin-top:8px;gap:10px;">
            <span class="badge ${x.ok ? "good":"bad"}">${x.ok ? "Correct":"Incorrect"}</span>
            <span class="help">Picked: <b>${escapeHTML(x.pickedText || "—")}</b></span>
            <span class="help">Correct: <b>${escapeHTML(x.correctText || "—")}</b></span>
          </div>
        </div>
      `).join("")}
    `;
    attemptDetail.scrollIntoView({behavior:"smooth", block:"start"});
  }

  function renderAnalytics(rows){
    const total = rows.length;
    const passCount = rows.filter(r => r.passed).length;
    const failCount = total - passCount;
    const passRate = total ? Math.round((passCount/total)*100) : 0;
    const avg = total ? Math.round(rows.reduce((s,r)=>s+(r.percent||0),0)/total) : 0;

    const now = Date.now();
    const dayMs = 24*60*60*1000;

    const last24 = rows.filter(r => (new Date(r.created_at)).getTime() >= (now - dayMs));
    const last24Pass = last24.filter(r=>r.passed).length;
    const last24Rate = last24.length ? Math.round((last24Pass/last24.length)*100) : 0;

    // 7-day buckets
    const buckets = [];
    for(let d=6; d>=0; d--){
      const start = now - (d+1)*dayMs;
      const end = now - d*dayMs;
      const dayRows = rows.filter(r=>{
        const t = (new Date(r.created_at)).getTime();
        return t >= start && t < end;
      });
      const dayPass = dayRows.filter(r=>r.passed).length;
      const rate = dayRows.length ? Math.round((dayPass/dayRows.length)*100) : 0;
      buckets.push({day: d, total: dayRows.length, rate});
    }

    const spark = buckets.map(b=>{
      const bars = Math.round((b.rate/100)*10);
      return `${"▮".repeat(bars)}${"▯".repeat(10-bars)} ${String(b.rate).padStart(3," ")}% (${b.total})`;
    }).join("<br/>");

    analyticsBox.innerHTML = `
      <b>Total attempts:</b> ${total}<br/>
      <b>Pass:</b> ${passCount} • <b>Fail:</b> ${failCount}<br/>
      <b>Pass rate:</b> ${passRate}%<br/>
      <b>Average score:</b> ${avg}%<br/>
      <div class="hr"></div>
      <b>Last 24h:</b> ${last24.length} attempts • ${last24Rate}% pass rate<br/>
      <div class="hr"></div>
      <b>Last 7 days trend:</b><br/>
      <span style="font-family:var(--mono)">${spark}</span>
    `;
  }

  /**********************
   * HELPERS
   **********************/
  function escapeHTML(s){
    return String(s).replace(/[&<>"']/g, (m)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  // Init
  setStatus("idle");
  renderProgress();
  </script>
</body>
</html>
